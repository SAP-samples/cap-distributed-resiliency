/* eslint-disable camelcase */
'use strict';
var xsenv = require('@sap/xsenv');
var tokenUtils = require('../../lib/utils/token-utils');
var businessServiceUtils = require('../utils/business-service-utils');

module.exports = {
  replaceUserToken: function (req, session, serviceTag, cb) {
    session = session || req.session;
    if (session.user.businessServices && serviceTag && session.user.businessServices[serviceTag] && session.user.businessServices[serviceTag].expireDate > Date.now()) {
      cb(null, session.user.businessServices[serviceTag].accessToken);
      return;
    }
    var ownUAACredentials = xsenv.serviceCredentials({label: 'xsuaa'});
    var externalServiceCredentials = serviceTag ? businessServiceUtils.getCredentials(serviceTag, false, req) : req.internalUrl.route.credentials;
    var routerConfig = req ? req.routerConfig : null;
    if (routerConfig && routerConfig.getToken) {
      routerConfig.getToken(req, function (err, accessToken) {
        if (err) {
          return cb(err);
        }
        tokenUtils.exchangeToken(accessToken, ownUAACredentials, externalServiceCredentials.uaa, cb);
      });
    } else {
      var jwt = session.user.token.accessToken;
      tokenUtils.exchangeToken(jwt, ownUAACredentials, externalServiceCredentials.uaa, cb);
    }
  }
};